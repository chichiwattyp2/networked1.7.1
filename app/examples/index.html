<html>
  <head>
    <meta charset="utf-8">
    <title>VR ROOM</title>
    <meta name="description" content="VR ROOM">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>

    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v5.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-text-geometry-component@^0.5.0/dist/aframe-text-geometry-component.min.js"></script> 
 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="/dist/networked-aframe.js"></script>
    <script src="/js/toggle-ownership.component.js"></script>
    <style src="/css/style.css"></style>

    <script>
        NAF.schemas.getComponentsOriginal = NAF.schemas.getComponents;

        // This one is necessary, because tracking the .head child component's material's color
        // won't happen unless we tell NAF to keep it in sync, like here.
        NAF.schemas.getComponents = (template) => {
          if (!NAF.schemas.hasTemplate("#head-template")) {
            NAF.schemas.add({
              template: '#head-template',
              components: [
                // position and rotation are synced by default, but if we declare
                // a custom schema, then ommitting them will cause them to go untracked.
                'position',
                'rotation',
                'player-info',
              ]
            });
          }

          const components = NAF.schemas.getComponentsOriginal(template);
          return components;
        }


    </script>


    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.2.0/dist/aframe-environment-component.min.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>




    <script src="https://rawgit.com/mayognaise/aframe-mouse-cursor-component/master/dist/aframe-mouse-cursor-component.min.js"></script>


  </head>

  <script>
      // always register components before your scene
    /*  AFRAME.registerComponent('tracked-vr-hands', {
        onEnterVR() {
          if (AFRAME.utils.device.isMobile()) return; // exclude e.g. cardboard, which lacks tracked controllers
          if (document.getElementById('my-tracked-right-hand')) return; // don't add them in more than once!
          ['left', 'right'].forEach(side => {
            const el = document.createElement('a-entity')
            el.setAttribute('hand-controls', {hand: side});
            el.setAttribute('networked', {template: `#${side}-hand-template`, attachTemplateToLocal: false});
            el.setAttribute('id', `my-tracked-${side}-hand`);
            this.el.appendChild(el);
          })
        },
        init() {
          this.el.sceneEl.addEventListener('enter-vr', this.onEnterVR.bind(this));
          // future improvements:
          // pick up hand-controls events
          // https://github.com/aframevr/aframe/blob/b164623dfa0d2548158f4b7da06157497cd4ea29/docs/components/hand-controls.md
          // and broadcast the matching gestures to other connected clients
          // possibly trigger the animation on the model itself using animation-mixer:
          // https://github.com/n5ro/aframe-extras/tree/master/src/loaders
          // could add as 'networked-hands' component within repo
        }
      })

      */

      AFRAME.registerComponent('player-info', {
        schema: {
          name: { type: 'string', default: "user-" + Math.round(Math.random()*10000) },
          color: { type: 'string', default: '#' + new THREE.Color( Math.random(), Math.random(), Math.random() ).getHexString() },
        },

        init: function() {
          this.head = this.el.querySelector('.head');
          this.nametag = this.el.querySelector('.nametag');
          this.ownedByLocalUser = this.el.id === "local-avatar";

          if (localStorage.getItem('person') == null){
            person = prompt("Wprowadź imię:", "Harry Potter");
            localStorage.setItem("person", person);
          } else {
            person = localStorage.getItem('person');
            console.log(localStorage.getItem('person'));
          }
            if (person !== null){
            this.data.name = person;
            }
          if (this.ownedByLocalUser) {
            this.nametagInput = document.getElementById("username-overlay");
            this.nametagInput.value = this.data.name;
          }
        },

        listUsers: function() {
          console.log("userlist", [...document.querySelectorAll('[player-info]')].map(el => el.components['player-info'].data.name));
        },

        update: function() {
          if (this.head) this.head.setAttribute('material', 'color', this.data.color);
          if (person !== null){
          if (this.nametag) this.nametag.setAttribute('value', this.data.name);
        }
        }
      });



  AFRAME.registerComponent('video-transport', {
  schema: {
    paused: {default: true},
    currentTime: {default: 0},
    timeSlop: {default: 0.5}
  },

  init: function () {
    // Find and remember our networked element.
    this.networkedEl = this.getNetworkedSelfOrAncestor();
  },

  update: function (oldData) {
    // Get the video element.
    var videoElement = this.getVideoElement();

    // If paused state is out of sync, take appropriate action.
    if (this.data.paused !== videoElement.paused) {
      this.data.paused ? videoElement.pause() : videoElement.play();
    }

    // If we are owner, this should be a local change, so just do it.
    // (We no longer need to ignore currentTime to prevent loop/race from tick.)
    var networked = this.networkedEl;
    if (!networked || networked.components.networked.data.owner === NAF.clientId) {
      videoElement.currentTime = this.data.currentTime;
    }

    // Implement some slop, so we don't keep trying to exactly match,
    // always failing due to buffer fetch etc.
    var delta = this.data.currentTime - videoElement.currentTime;
    if (delta < 0.0 || delta > this.data.timeSlop) {
      videoElement.currentTime = this.data.currentTime;
    }
  },

  tick: function (t, dt) {
    // If there are no other clients yet, no need to do any sync logic.
    if (!NAF.connection || !NAF.connection.connectedClients) { return; }

    // If not owner, then we're not master, so don't sync data to actual video values.
    var networked = this.networkedEl;
    if (networked.components.networked.data.owner !== NAF.clientId) { return; }

    // Get the video element.
    var videoElement = this.getVideoElement();

    // Read transport data values from the video element.
    // NOTE: Apparently, we can change the data without going through setAttribute,
    // which should not cause update() to fire, and the values still sync properly.
    if (this.data.paused !== videoElement.paused) {
      this.data.paused = videoElement.paused;
    }
    if (this.data.currentTime !== videoElement.currentTime) {
      this.data.currentTime = videoElement.currentTime;
    }
  },

  // Utility function to get the applicable networked element.
  getNetworkedSelfOrAncestor: function () {
    for (var networked = this.el; networked; networked = networked.parentElement) {
      if (networked.components && networked.components.networked) {
        break;
      }
    }
    return networked;
  },

  // Utility function to get the applicable video element.
  getVideoElement: function () {
    var videoElement = this.el.components.material;
    if (videoElement) { videoElement = videoElement.material.map; }
    if (videoElement) { videoElement = videoElement.image; }
    return videoElement;
  }
});

    </script>



  <body>
     <div class="actions"  style="z-index: 100; bottom: 24px; left: 24px; position:fixed;">
    <input
      id="username-overlay"
      oninput="document.getElementById('local-avatar').setAttribute('player-info', 'name', this.value);localStorage.setItem('person', this.value);"
    ></input>
      <button id="mic-btn" type="button" class="button">Wycisz mikrofon</button>
      <button id="camera-btn" type="button" class="button">Wyłącz Kamerę</button>
      <button id="screen-btn" type="button" class="button">Udostępnij ekran</button>
      <span id="video-permission" style="display:none">
      <button id="video-permission-button">Zezwól na video VR</button>
      </span>
    </div>
  <!-- embedded - place into div / stats - performance info -->
    <a-scene
      physics="gravity: -9.8"
      networked-scene="
        room: test;
        adapter: easyrtc;
        debug: true;
        audio: true;
        video: true;
      "
      fog="type: linear; near:12; far:20; color: #dbdedb;"
      >



      <a-assets>
         <a-asset-item id="left-hand-model" src="./assets/leftHandHigh.glb"></a-asset-item>
         <a-asset-item id="right-hand-model" src="./assets/rightHandHigh.glb"></a-asset-item>



        <img src="https://cdn.glitch.me/f0261702-fff6-4770-a0a6-4106039d7496%2Fplay.png?v=1639014099163" id="play" crossorigin="anonymous">
        <img src="https://cdn.glitch.me/f0261702-fff6-4770-a0a6-4106039d7496%2Fpause.png" id="pause" crossorigin="anonymous">
        <img src="https://cdn.glitch.me/f0261702-fff6-4770-a0a6-4106039d7496%2Fvolume-normal.png" id="volume-normal" crossorigin="anonymous">
        <img src="https://cdn.glitch.me/f0261702-fff6-4770-a0a6-4106039d7496%2Fvolume-mute.png" id="volume-mute" crossorigin="anonymous">
        <img src="https://cdn.glitch.me/f0261702-fff6-4770-a0a6-4106039d7496%2Fseek-back.png" id="seek-back" crossorigin="anonymous">


        
        <!-- 3d models -->
        <a-asset-item id="workshop" response-type="arraybuffer" src="https://cdn.glitch.me/f0261702-fff6-4770-a0a6-4106039d7496/Workshop%2002.glb?v=1641160760978"></a-asset-item>
        <a-asset-item id="quizroom" response-type="arraybuffer" src="https://cdn.glitch.me/f0261702-fff6-4770-a0a6-4106039d7496/Quiz%20room.glb?v=1641165529814"></a-asset-item>
        <a-asset-item id="chairs" response-type="arraybuffer" src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Chairs%20-%20lowpoly.glb?v=1640355613514"></a-asset-item>
        <a-asset-item id="car01" response-type="arraybuffer" src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Car01.glb?v=1640093921735"></a-asset-item>
        <a-asset-item id="car02" response-type="arraybuffer" src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Car02.glb?v=1640093990701"></a-asset-item>
        <a-asset-item id="car03" response-type="arraybuffer" src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Car03.glb?v=1640094003600"></a-asset-item>
        <a-asset-item id="opal" response-type="arraybuffer" src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Opal.glb?v=1641080869615"></a-asset-item>
  
        <a-asset-item id="matrix2" response-type="arraybuffer" src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Matrix.glb?v=1641080580493"></a-asset-item>
        <a-asset-item id="matrix3" response-type="arraybuffer" src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Matrix.glb?v=1641080580493"></a-asset-item>
        
         
     
        <a-asset-item id="optimerBoldFont" src="https://rawgit.com/mrdoob/three.js/dev/examples/fonts/optimer_bold.typeface.json"></a-asset-item>







        <!--
          NAF Templates
        -->



        <!-- Camera Rig / Player -->
        <template id="camera-rig-template">
          <a-entity networked-audio-source dynamic-body="radius: 0.8">
          </a-entity>
        </template>

        <!-- Head / Avatar -->
        <!--      a few spheres make a head + eyes + pupils    -->
        <template id="head-template">
          <a-entity class="avatar" player-info>
            <!-- <a-plane id="share"  width="3" height="2.25" position="1.5 2 0" networked-video-source="streamName: screen"  material="side: double"></a-plane> -->
            <a-plane id="share-plane" width="4" height="3" position="0 2 0" visible="true"  material="side: double" networked-video-source></a-plane>
              <a-sphere class="head" color="blue" scale="0.2 0.22 0.2" ></a-sphere>
            <a-entity class="face" position="0 0.05 0" >
              <a-sphere class="eye" color="white" position="0.06 0.05 -0.16" scale="0.04 0.04 0.04" >
                <a-sphere class="pupil"  color="black" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
              </a-sphere>
              <a-sphere class="eye" color="white" position="-0.06 0.05 -0.16" scale="0.04 0.04 0.04">
                <a-sphere class="pupil" color="black" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
              </a-sphere>
            <a-text class="nametag" value="?" rotation="0 180 0" position=".25 -.35 0" side="double" scale=".5 .5 .5"></a-text>
          </a-entity>
        </template>

        <!-- Hands -->
        <template id="left-hand-template">
          <a-entity>
            <a-gltf-model class="tracked-left-hand" rotation="0 0 90" src="#left-hand-model"></a-gltf-model>
          </a-entity>
        </template>

        <template id="right-hand-template">
          <a-entity>
            <a-gltf-model class="tracked-right-hand" rotation="0 0 -90" src="#right-hand-model"></a-gltf-model>
          </a-entity>
        </template>




        <!-- Stream networked-video-source="streamName: screen" -->
        <template id="stream-template">

          <a-entity>
            <video  id="share-screen" autoplay crossorigin="anonymous"></video>
            <a-video id="share-it" src="#share-screen" width="18" height="12" position="0 5 0"  material="side: double" networked-video-source="streamName: screen" ></a-video>
          </a-entity>
        </template>



        <!-- Because this video needs crossorigin etc., we need to use
             a-video src with selector, not a-plane material src string. -->
        <video id="video-src" src="https://cdn.glitch.me/28352ca2-48f1-449d-9526-ce21f7f08e27%2FInteligentny%20Dom%20-%2020%20sek.mp4" width="160" height="90" crossorigin="anonymous"></video>
        <template id="singleton-template">
          <a-entity toggle-ownership>
            <a-video  id="video-screen" video-transport class="front" width="16" height="9" material="side: double"
              src="#video-src"></a-video>
          </a-entity>
        </template>

      </a-assets>


      <!-- screen sharing screen -->
      <a-entity id="stream"
        networked="template:#stream-template;attachTemplateToLocal:false;"
        rotation="0 90 0" 
        position="3 3 50"
        >

      </a-entity>
      <a-entity gltf-model="#chairs" scale="0.7 0.7 0.7" position="41 0 50" rotation="0 0 0"></a-entity>




      <a-entity environment="preset:starry; groundColor: #000000;shadow:true;shadowSize: 5;ground:flat;"></a-entity>






      <a-animation attribute="rotation" to="0 0 0" repeat="indefinite" dur="10000"></a-animation>

      <a-entity gltf-model="#workshop" position="-20 0 -35" scale=".9 1.3 1"></a-entity>
      
      <a-entity gltf-model="#quizroom" position="8 0 50" rotation="0 180 0" scale="1 1.3 1"></a-entity>
      
      
      
      <a-entity gltf-model="#car01" scale="1 1 1" position="-10 0.2 0"> </a-entity>
      <a-entity id="lightSphere" geometry="primitive: torus" radius="5" rotation="-90 0 0" scale="0.5 0.5 0.05" material="shader: flat" light="type: point; color: purple; intensity: 3" position="-26 4 0"></a-entity>
      
      <a-entity gltf-model="#car02" scale="1 1 1" position="20 0.2 0"></a-entity>
      <a-entity id="lightSphere" geometry="primitive: torus" radius="5" rotation="-90 0 0" scale="0.5 0.5 0.05" material="shader: flat" light="type: point; color: blue; intensity: 3" position="14 4 -10"></a-entity>
      
      
      <a-entity gltf-model="#car03" position="27 0.2 15" rotation="0 25 0"></a-entity>
      <a-entity id="lightSphere" geometry="primitive: torus" radius="5" rotation="-90 0 0" scale="0.5 0.5 0.05" material="shader: flat" light="type: point; color: pink; intensity: 3" position="31.93274 4 13.83978"></a-entity>
      
      
      
      <a-entity gltf-model="#opal" position="-5 2.5 0" scale="0.015 0.015 0.015" animation-mixer="clip:Take 001; loop:2; timeScale: 0.2; crossFadeDuration: 1"></a-entity>
      
      
      
      <a-entity gltf-model="#matrix2" position="35 15 -5" scale="1 1 1" rotation="0 -45 0" animation-mixer="clip:Animation; loop:2; timeScale: 0.2; crossFadeDuration: 1"></a-entity>
      <a-entity gltf-model="#matrix3" position="-55 15 32" scale="1 1 1" rotation="0 -45 0" animation-mixer="clip:Animation; loop:2; timeScale: 0.2; crossFadeDuration: 1"></a-entity>
      
      <a-box color="#221923" depth="2" height="4" width="0.5" position="4.825 7.174 -35.90" scale="15.60 3.596 10.114"></a-box>
      <a-box color="#221923" depth="2" height="4" width="0.5" position="26.56 4.238 -35.90" scale="38 2 10"></a-box>
      <a-box color="#221923" depth="2" height="4" width="0.5" position="43 12 -50" scale="38 6 10"></a-box>
      <a-box color="#221923" depth="2" height="4" width="0.5" position="48 5 41" scale="20 3 10"></a-box>
      <a-box color="#221923" depth="2" height="4" width="0.5" position="-25 2 50" scale="38 3 10"></a-box>

      <a-box color="#221923" depth="2" height="4" width="0.5" position="-5 5 53" scale="20 3 10"></a-box>
      <a-box color="#221923" depth="2" height="4" width="0.5" position="-30 12 60" scale="30 6 10"></a-box>
      <a-box color="#221923" depth="2" height="4" width="0.5" position="-62 6 -29" scale="38 3 10"></a-box>
      <a-box color="#221923" depth="2" height="4" width="0.5" position="-80 12 -23" scale="38 6 10"></a-box>
      <a-box color="#221923" depth="2" height="4" width="0.5" position="62 11 47" scale="38 6 10"></a-box>
      
        
        
      <a-box position="-13.14768 5.24428 -19.45398" rotation="90 0 0" scale="27.56 0.1 10" material="color: #111; opacity: 0.5; transparent: true"></a-box>
      
     <!-- <a-box position="35 0.05624 0"  color="black" scale="12 0.11858 12" ></a-box>
      <a-box position="35 6 0" color="black" scale="12 0.11858 12"></a-box>
      <a-box position="35 3 -6" rotation="90 0 0" color="black" scale="12 0.11858 6"></a-box>
      <a-box position="29 3 00" rotation="90 90 0" color="black" scale="12 0.1 6"></a-box>
      <a-box position="41 3 00" rotation="90 90 0" color="black" scale="12 0.1 6"></a-box> -->
    
      <a-cylinder color="#110C11" height="0.3" radius="1.5" position="-5 1 0"></a-cylinder>
      <a-cylinder color="#110C11" height="0.3" radius="2.5" position="-5 0.3 0"></a-cylinder>
        
      <a-cylinder color="#0E061E" height="0.3" radius="2.5" position="-25 0.3 0" scale="2 1 1.6" rotation="0 -45 0"></a-cylinder>  
      <a-cylinder color="#0E061E" height="0.3" radius="2.5" position="30 0.3 13" scale="2 1 1.6" rotation="0 57 0"></a-cylinder>
      <a-cylinder color="#0E061E" height="0.3" radius="2.5" position="14 0.3 -10" scale="2 1 1.6" ></a-cylinder>
        
     <!-- <a-plane src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Floor01-01-01.png?v=1640020849850" position="0 0 0" rotation="-90 0 0" width="31.5" height="31.5" shadow></a-plane>
      <a-plane src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Floor01-01-01.png?v=1640020849850" position="31.5 0 0" rotation="-90 0 0" width="31.5" height="31.5" shadow></a-plane>
      <a-plane src="https://cdn.glitch.me/4d4d5ff9-cd73-4637-8630-e2f868d0280c/Floor01-01-01.png?v=1640020849850" position="-31.5 0 0" rotation="-90 0 0" width="31.5" height="31.5" shadow></a-plane>
      -->

      <a-entity light="type: ambient; color: #FDFEFE"></a-entity>

      



      <a-entity light="color: #ccccff; intensity: 2; type: ambient;" visible="true"></a-entity>
      <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>


      <a-box static-body position="0 0 10" height="3" width="4" color="#222222"></a-box>





      <a-entity id="camera-rig"
                tracked-vr-hands
                movement-controls="fly:false;"
                spawn-in-circle="radius:10"
                networked="template:#camera-rig-template;"
                dynamic-body="radius: 0.8"
                look-controls
      >

        <a-entity camera  id="local-avatar" position="0 1.6 0" networked="template:#head-template;"
                   visible="false">
        </a-entity>
        <a-cursor fuse="true" timeout="500" color="#F0F0F0" scale="0.6 0.6 0.6"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          position="0 1.6 -1"
          visible="true"
          >
        </a-cursor>


      </a-entity>





      <!-- Define the singleton (by using explicit networkId), with no initial owner. -->
      <a-entity  class="singleton" position="-2 6 -35" rotation="0 -90 0"
                networked="template:#singleton-template;networkId:singleton;owner:nobody">
      </a-entity>
      <a-entity gltf-model="#chairs" scale="0.7 0.7 0.7" position="-50 0 -35" rotation="0 180 0"></a-entity>





      <!-- VIDEO PLAYER -->

      <a-plane position="-2 9.5 -23" rotation="0 -90 0" color="red" id="changer"> </a-plane>
      <a-plane position="-2 7.5 -23" rotation="0 -90 0" material="side: double" color="blue" id="changer-1"> </a-plane>
      <!-- MEDIAS HOLDER -->
      <a-sound id="alert-sound" src="src: url(https://cdn.glitch.me/f0261702-fff6-4770-a0a6-4106039d7496%2Fassets_action.wav)" autoplay="false" position="0 0 0"></a-sound>

      <!-- END MEDIAS HOLDER -->

      <!-- CONTROLS -->
      <a-image id="control-back"  rotation="0 -90 0" width="0.4" height="0.4" src="#seek-back" position="-7 0.6 -36" visible="false" scale="0.85 0.85 0.85"></a-image>
      <a-image id="control-play"  rotation="0 -90 0" width="0.4" height="0.4" src="#play" position="-7 0.6 -35"></a-image>
      <a-image id="control-volume"  rotation="0 -90 0" width="0.4" height="0.4" src="#volume-normal" position="-7 0.6 -34" visible="false" scale="0.75 0.75 0.75"></a-image>
      <!-- END CONTROLS -->

      <!-- PROGRESSBAR -->
      <a-entity id="progress-bar" geometry="primitive: plane; width: 4; height: 0.06;"
          material="transparent: true; opacity: 0;"  rotation="0 -90 0" position="-7 0.1 -35">
        <a-plane id="progress-bar-track" width="4" height="0.06" color="black" position="0 0 0.005" opacity="0.2" visible="true"></a-plane>
        <a-plane id="progress-bar-fill" width="0" height="0.06" color="#7198e5" position="-2 0 0.01" visible="false"></a-plane>
      </a-plane>
      <!-- END PROGRESSBAR -->






    </a-scene>
    <script>

    var singletonSchema = {
        template: '#singleton-template',
        components: [
          'position',
          'rotation',

          // This won't work when the video is referenced by selector!
          // And some videos won't work this way regardless, due to CORS
          {
            selector: '.front',
            component: 'src',
          },

          // This works but needs care when syncing, to avoid continual resync.
          {
            selector: '.front',
            component: 'video-transport',
            property: 'currentTime'
          },

          // There may be an order of operations race condition to prevent,
          // when restarting the position needs to be reset before play,
          // or else the play will fail due to the end position.
          {
            selector: '.front',
            component: 'video-transport',
            property: 'paused'
          }
        ]
      };
      NAF.schemas.add(singletonSchema);

    </script>








    <!-- VIDEO PLAYER -->
    <script src="/js/video-player.js"></script>
    <script type="text/javascript">
      let scene = document.querySelector('a-scene');

      /**
      * CINEMA MODE
      */
      scene.lightOff = function() {
        scene.islightOn = true;
        scene.removeAttribute('animation__fogback');
        scene.setAttribute('animation__fog', "property: fog.color; to: #0c192a; dur: 800; easing: easeInQuad;");
      }
      scene.lightOn = function() {
        scene.islightOn = false;
        scene.removeAttribute('animation__fog');
        scene.setAttribute('animation__fogback', "property: fog.color; to: #dbdedb; dur: 800");
      }

      /**
      * AVideoPlayer
      */
      var videoPlayer = new AVideoPlayer();


      // Play button action
      document.querySelector('#control-play').addEventListener('click', function () {
        if (videoPlayer.paused) {
          scene.lightOn()
        } else {
          scene.lightOff();
        }
      });



      // Changers button action

      document.querySelector('#changer').addEventListener('click', function () {
        document.getElementById('video-src').src = 'https://cdn.glitch.me/28352ca2-48f1-449d-9526-ce21f7f08e27%2FInteligentny%20Dom%20-%2020%20sek.mp4?v=1637094630575';

        videoPlayer._playAudioAlert();
        videoPlayer.elControlPlay.setAttribute('src', '#pause');
        videoPlayer.elVideo.paused = false;
        videoPlayer.isControlVisible(true);
        videoPlayer.elVideo.play();



      });

      document.querySelector('#changer-1').addEventListener('click', function () {
        document.getElementById('video-src').src = 'https://cdn.glitch.me/f0261702-fff6-4770-a0a6-4106039d7496%2Finterstellar.mp4?v=1639014972368';

        videoPlayer._playAudioAlert();
        videoPlayer.elControlPlay.setAttribute('src', '#pause');
        videoPlayer.elVideo.paused = false;
        videoPlayer.isControlVisible(true);
        videoPlayer.elVideo.play();



      });





    </script>





    <script>
      // Mic status
      let micEnabled = false;
      // Mic button ele
      const micBtnEle = document.getElementById('mic-btn');

      // Camera status
      let cameraEnabled = true;
      // Camera button element
      const cameraBtnEle = document.getElementById('camera-btn');

      // Screen share status
      let screenEnabled = false;
      // Screen share button element
      const screenBtnEle = document.getElementById('screen-btn');






      // Called by Networked-Aframe when connected to server
      function onConnect () {
        console.log("onConnect", new Date());

        //updateColor();
         // Handle mic button click (Mute and Unmute)
        micBtnEle.addEventListener('click', function() {
          NAF.connection.adapter.enableMicrophone(!micEnabled);
          micEnabled = !micEnabled;
          micBtnEle.textContent = micEnabled ? 'Wycisz mikrofon' : 'Włącz mikrofon';
        });


        // Handle camera button click (Off and On)
        cameraBtnEle.addEventListener('click', setCam);

        setCam();

        // Handle screen button click (Off and On)
        // https://developer.mozilla.org/en-US/docs/Web/API/Screen_Capture_API/Using_Screen_Capture


        screenBtnEle.addEventListener('click', setScreen);
        //setScreen();



      /*
      Known issues with screen sharing, some cases are not handled:
      - If participant A shares their screen, the partipant B sees the other participant's screen.
        When participant A stops their screen share, the other participant will see a frozen screen, the last image received.
      - If participant A starts screen share, stops, and restarts the screen share, the other participant won't see it.
       */















          // Set up the lone ownership timeout.
       var lonerTimeout = setTimeout(function() {
          // This would be more useful if there were multiple singletons in the example.
          Array.prototype.slice.call(document.querySelectorAll('.singleton[networked]'))
            .map(function (el) {
              // Take ownership.
              el.setAttribute('networked', 'owner', NAF.clientId);
              console.warn('Took ownership as ', NAF.clientId, ' of ', el);
            });
        }, 500);




        document.body.addEventListener('clientConnected', function (evt) {
          console.warn('clientConnected ', evt.detail.clientId);
          // Cancel the lone ownership timeout.
          clearTimeout(lonerTimeout);
        });

        document.body.addEventListener('clientDisconnected', function (evt) {
          console.warn('clientDisconnected ', evt.detail.clientId);
        });



      }

      function setCam() {

          NAF.connection.adapter.enableCamera(!cameraEnabled);

          cameraEnabled = !cameraEnabled;
          /*if(NAF.utils.isMine(document.getElementById('share-plane'))==true) {
            document.getElementById('share-plane').setAttribute('visible','true');
          }*/


          cameraBtnEle.textContent = cameraEnabled ? 'Wyłącz Kamerę' : 'Włącz Kamerę';
      }

      async function setScreen() {
        let videoElem = document.getElementById('share-screen');
        if (screenEnabled) {


        //  console.log(NAF.connection.adapter);

          /*let tracks = videoElem.srcObject.getTracks();
          console.log(tracks);
          tracks.forEach(track => track.stop());
          delete videoElem.srcObject;
          console.log(videoElem);*/

          //NAF.connection.adapter.removeLocalMediaStream("screen");
          //delete NAF.connection.adapter.mediaStreams.local.screen;
          window.location.reload()
          //screenEnabled = false;
          //screenBtnEle.textContent = 'Udostępnij ekran';


        } else {

          /*try {
            videoElem.srcObject = await navigator.mediaDevices.getDisplayMedia();
            console.log(videoElem.srcObject);
            videoElem.play();
          } catch(err) {
            console.error("Error: " + err);
          }*/


          navigator.mediaDevices.getDisplayMedia().then((stream) => {
            NAF.connection.adapter.addLocalMediaStream(stream, "screen");
            NAF.connection.adapter.mediaStreams.local.screen.oninactive = testFunc;
            console.log(NAF.connection.adapter.mediaStreams.local.screen);
            console.log(NAF.connection.adapter.mediaStreams.local.screen.getTracks());
          });



          screenEnabled = true;
          screenBtnEle.textContent = 'Wyłącz udostępnianie ekranu';
        }
      }


      function testFunc(activity) {
        if ((NAF.connection.adapter.mediaStreams.local.screen.active == true)){
          return;
        } else {


          //let tracks = NAF.connection.adapter.mediaStreams.local.screen.getTracks();
          //tracks.forEach(track => delete track);
          //delete NAF.connection.adapter.mediaStreams.local.screen

          //NAF.connection.adapter.removeLocalMediaStream("screen");

          console.log('not active :()');

          screenEnabled = false;
          screenBtnEle.textContent = 'Udostępnij ekran';
          window.location.reload()
        }

      }







    </script>


  </body>
</html>
